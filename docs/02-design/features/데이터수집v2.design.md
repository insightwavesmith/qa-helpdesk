# 데이터수집 v2 설계서

> 작성: backend-dev | 2026-02-27
> 참조: TASK-데이터수집v2.md, collect-benchmarks/route.ts (GCP 방식 레퍼런스)

---

## 1. 목표

`collect-daily/route.ts`를 `collect-benchmarks/route.ts`와 동일한 GCP 기반 방식으로 정합성 맞추기.
현재 불일치 항목:
- `video_p3s_rate` 분모: reach → impressions
- `retention_rate`: thruplay/videoP3s → video_p100/videoP3s
- 랭킹 3종 미수집: quality_ranking, engagement_ranking, conversion_ranking
- `video_p100` 미수집/미저장
- ACTIVE 광고 필터 없음

---

## 2. 데이터 모델 변경

### daily_ad_insights 컬럼 추가

| 컬럼 | 타입 | 기본값 | 설명 |
|------|------|--------|------|
| `video_p100` | INTEGER | 0 | 100% 시청 횟수 (video_p100_watched_actions) |

※ `quality_ranking`, `engagement_ranking`, `conversion_ranking`은 이미 database.ts에 정의됨.
실제 DB 컬럼 없으면 함께 추가.

---

## 3. API 설계

### 3-1. Meta API 필드 변경

```
현재 fields:
spend,impressions,clicks,actions,action_values,ctr,cpc,cpm,frequency,reach,
video_play_actions,video_thruplay_watched_actions

변경 후 fields:
spend,impressions,clicks,actions,action_values,ctr,cpc,cpm,frequency,reach,
video_play_actions,video_thruplay_watched_actions,
video_p100_watched_actions,
quality_ranking,engagement_rate_ranking,conversion_rate_ranking
```

### 3-2. ACTIVE 광고 필터 추가

```
filtering=[{"field":"effective_status","operator":"IN","value":["ACTIVE"]}]
```

---

## 4. 계산식 변경

| 지표 | 현재 | 변경 |
|------|------|------|
| `video_p3s_rate` | videoP3s / reach × 100 | videoP3s / impressions × 100 |
| `retention_rate` | thruplay / videoP3s × 100 | video_p100 / videoP3s × 100 |

---

## 5. 저장 필드 추가

```typescript
// calculateMetrics() 반환값에 추가
quality_ranking: normalizeRanking(insight.quality_ranking),
engagement_ranking: normalizeRanking(insight.engagement_rate_ranking),
conversion_ranking: normalizeRanking(insight.conversion_rate_ranking),
video_p100: safeInt(getVideoActionValue(insight.video_p100_watched_actions)),
```

---

## 6. normalizeRanking 함수

collect-benchmarks에서 동일 함수 복사:

```typescript
function normalizeRanking(raw: string | undefined | null): string {
  if (!raw) return 'UNKNOWN';
  const u = raw.toUpperCase().replace(/-/g, '_');
  if (u.includes('ABOVE')) return 'ABOVE_AVERAGE';
  if (u.includes('BELOW')) return 'BELOW_AVERAGE';
  if (u === 'AVERAGE') return 'AVERAGE';
  return 'UNKNOWN';
}
```

---

## 7. 구현 순서

1. `supabase/migrations/20260227_ranking_video_p100.sql` 생성 (DB 컬럼 추가)
2. `collect-daily/route.ts` 수정:
   - Meta API fields에 ranking + video_p100 필드 추가
   - ACTIVE 필터 추가
   - `normalizeRanking()` 함수 추가
   - `calculateMetrics()` 수정: 분모 변경, ranking/video_p100 추가
   - Supabase upsert에 ranking/video_p100 컬럼 포함
3. `npm run build` + `npx tsc --noEmit` 확인
4. 커밋

---

## 8. 에러 처리

- Meta API ranking 필드 없을 시 → `normalizeRanking(null)` → 'UNKNOWN' 반환
- video_p100_watched_actions 없을 시 → 0 반환
- 기존 에러 처리 방식 유지

---

## 9. 완료 기준

- [ ] video_p3s_rate 분모 = impressions
- [ ] retention_rate = video_p100 / videoP3s
- [ ] quality_ranking, engagement_ranking, conversion_ranking DB 저장
- [ ] video_p100 DB 저장
- [ ] ACTIVE 필터 적용 (활성 광고만 수집)
- [ ] `npm run build` 성공
