<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>콘텐츠 파이프라인 v3 아키텍처 보고서</title>
  <meta property="og:title" content="콘텐츠 파이프라인 v3 아키텍처 보고서">
  <meta property="og:description" content="QA 이슈 5건 해소를 위한 v3 아키텍처 재설계 — ADR 5건, Mermaid 다이어그램 3종, 구현 로드맵 포함.">
  <meta property="og:type" content="article">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
      startOnLoad: true,
      theme: 'base',
      themeVariables: {
        primaryColor: '#FEF2F2',
        primaryBorderColor: '#F75D5D',
        primaryTextColor: '#1a1a1a',
        lineColor: '#9ca3af',
        fontSize: '13px',
        edgeLabelBackground: '#ffffff'
      },
      flowchart: { htmlLabels: true, curve: 'basis' },
      sequence: { mirrorActors: false, messageAlign: 'center' }
    });
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #F75D5D;
      --primary-hover: #E54949;
      --bg: #ffffff;
      --text: #1a1a1a;
      --text-sub: #374151;
      --text-muted: #6b7280;
      --text-faint: #9ca3af;
      --border: #e5e7eb;
      --surface: #f8f9fc;
      --surface-warm: #FEF2F2;
      --sidebar-w: 220px;
    }
    body {
      font-family: "Pretendard", -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg); color: var(--text); line-height: 1.7;
    }
    /* Sidebar */
    .sidebar {
      position: fixed; top: 0; left: 0; width: var(--sidebar-w); height: 100vh;
      background: var(--surface); border-right: 1px solid var(--border);
      padding: 24px 16px; overflow-y: auto; z-index: 100;
    }
    .sidebar-title { font-size: 13px; font-weight: 800; color: var(--primary); margin-bottom: 16px; letter-spacing: 1px; text-transform: uppercase; }
    .sidebar nav a {
      display: block; padding: 5px 10px; font-size: 12.5px; color: var(--text-muted);
      text-decoration: none; border-left: 2px solid transparent; border-radius: 0 4px 4px 0;
      transition: all .15s;
    }
    .sidebar nav a:hover { color: var(--text); background: var(--surface-warm); }
    .sidebar nav a.active { color: var(--primary); border-left-color: var(--primary); font-weight: 600; background: var(--surface-warm); }
    .sidebar nav .sep { height: 1px; background: var(--border); margin: 8px 10px; }
    /* Main */
    .main { margin-left: var(--sidebar-w); padding: 40px 48px 80px; max-width: 920px; }
    /* Typography */
    h1 { font-size: 26px; font-weight: 800; margin-bottom: 6px; }
    h2 { font-size: 18px; font-weight: 700; margin: 40px 0 14px; padding-bottom: 8px; border-bottom: 2px solid var(--primary); scroll-margin-top: 24px; }
    h3 { font-size: 15px; font-weight: 700; margin: 20px 0 8px; color: var(--text-sub); }
    h4 { font-size: 14px; font-weight: 700; margin: 16px 0 6px; }
    p, li { font-size: 14px; color: var(--text-sub); }
    p { margin-bottom: 12px; }
    ul, ol { padding-left: 20px; margin-bottom: 12px; }
    li { margin-bottom: 4px; }
    /* Badges */
    .badge { display: inline-block; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .badge-proposed { background: #DBEAFE; color: #1E40AF; }
    .badge-ok { background: #DCFCE7; color: #166534; }
    .badge-warn { background: #FEF9C3; color: #854D0E; }
    .badge-danger { background: #FEE2E2; color: #991B1B; }
    .badge-info { background: #DBEAFE; color: #1E40AF; }
    .badge-purple { background: #F3E8FF; color: #6B21A8; }
    .badge-p0 { background: #FEE2E2; color: #991B1B; font-weight: 700; }
    .badge-p1 { background: #FEF9C3; color: #854D0E; font-weight: 700; }
    .badge-p2 { background: #DBEAFE; color: #1E40AF; font-weight: 700; }
    /* Meta */
    .meta { font-size: 13px; color: var(--text-faint); margin-bottom: 28px; display: flex; flex-wrap: wrap; gap: 16px; }
    /* Summary Box */
    .summary-box { background: var(--surface-warm); border-left: 4px solid var(--primary); padding: 16px 20px; border-radius: 0 8px 8px 0; margin-bottom: 24px; }
    .summary-box strong { color: var(--primary); }
    /* Code */
    pre { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; overflow-x: auto; font-size: 13px; line-height: 1.6; margin-bottom: 16px; }
    code { font-family: "SF Mono", "Fira Code", monospace; font-size: 13px; }
    pre code { color: var(--text-sub); }
    p code, li code, td code { background: #f3f4f6; padding: 1px 6px; border-radius: 4px; color: var(--primary-hover); font-size: 12px; }
    /* Table */
    table { width: 100%; border-collapse: collapse; margin-bottom: 16px; font-size: 13px; }
    th, td { border: 1px solid var(--border); padding: 10px 12px; text-align: left; }
    th { background: var(--surface-warm); font-weight: 600; color: var(--text-muted); }
    /* Issue Card */
    .issue-card { border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .issue-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
    .issue-num { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 8px; background: var(--primary); color: #fff; font-size: 14px; font-weight: 800; flex-shrink: 0; }
    .issue-title { font-size: 15px; font-weight: 700; }
    .issue-meta { font-size: 12px; color: var(--text-faint); margin-bottom: 12px; }
    /* ADR */
    .adr { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 24px; }
    .adr-header { padding: 14px 20px; background: var(--surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
    .adr-num { display: inline-flex; align-items: center; justify-content: center; min-width: 32px; height: 24px; border-radius: 6px; background: var(--primary); color: #fff; font-size: 12px; font-weight: 700; padding: 0 8px; }
    .adr-title { font-size: 14px; font-weight: 700; }
    .adr-body { padding: 20px; }
    .adr-section { margin-bottom: 16px; }
    .adr-section:last-child { margin-bottom: 0; }
    .adr-section-title { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .consequence { padding: 4px 0; font-size: 13px; }
    .consequence .plus { color: #166534; font-weight: 700; }
    .consequence .minus { color: #991B1B; font-weight: 700; }
    .consequence .neutral { color: #854D0E; font-weight: 700; }
    /* Impact */
    .impact-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px 0; }
    .impact-card { border: 1px solid var(--border); border-radius: 8px; padding: 16px; text-align: center; }
    .impact-card .num { font-size: 28px; font-weight: 800; color: var(--primary); }
    .impact-card .label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
    /* Layer */
    .layer-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; margin-right: 4px; }
    .layer-0a { background: #DBEAFE; color: #1E40AF; }
    .layer-0b { background: #E0E7FF; color: #3730A3; }
    .layer-1a { background: #FEF9C3; color: #854D0E; }
    .layer-1b { background: #FFEDD5; color: #9A3412; }
    .layer-2 { background: #F3E8FF; color: #6B21A8; }
    /* Roadmap */
    .roadmap-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin: 16px 0; }
    .roadmap-card { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .roadmap-card-header { padding: 12px 16px; font-weight: 700; font-size: 13px; display: flex; align-items: center; gap: 8px; }
    .roadmap-card-header.p0 { background: #FEE2E2; color: #991B1B; }
    .roadmap-card-header.p1 { background: #FEF9C3; color: #854D0E; }
    .roadmap-card-header.p2 { background: #DBEAFE; color: #1E40AF; }
    .roadmap-card-body { padding: 16px; font-size: 13px; }
    .roadmap-card-body .file-tag { display: inline-block; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; padding: 1px 6px; font-size: 11px; margin: 2px; font-family: "SF Mono", monospace; }
    /* Edge */
    .edge-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0; }
    .edge-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px 14px; }
    .edge-card .edge-id { font-size: 11px; font-weight: 700; color: var(--primary); }
    .edge-card .edge-title { font-size: 13px; font-weight: 600; margin: 4px 0; }
    .edge-card .edge-desc { font-size: 12px; color: var(--text-muted); }
    /* Spec */
    .spec-box { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .mermaid { margin: 16px 0 24px; }
    footer { margin-top: 48px; padding-top: 16px; border-top: 1px solid var(--border); font-size: 12px; color: var(--text-faint); }
    @media (max-width: 800px) {
      .sidebar { display: none; }
      .main { margin-left: 0; padding: 24px 16px 60px; }
      .impact-grid, .roadmap-grid { grid-template-columns: 1fr; }
      .edge-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- ============================== Sidebar ============================== -->
<aside class="sidebar">
  <div class="sidebar-title">v3 Architecture</div>
  <nav id="toc">
    <a href="#executive-summary">요약</a>
    <a href="#current-architecture">현재 아키텍처 v2.1</a>
    <a href="#qa-issues">QA 이슈 5건</a>
    <div class="sep"></div>
    <a href="#v3-architecture">v3 아키텍처</a>
    <a href="#diagram-component">컴포넌트 다이어그램</a>
    <a href="#diagram-sequence">시퀀스 다이어그램</a>
    <a href="#diagram-dataflow">데이터 흐름도</a>
    <div class="sep"></div>
    <a href="#adr-1">ADR-1 RAG 주입 위치</a>
    <a href="#adr-2">ADR-2 타입 통합</a>
    <a href="#adr-3">ADR-3 email_summary 검증</a>
    <a href="#adr-4">ADR-4 미리보기 UX</a>
    <a href="#adr-5">ADR-5 토큰 예산</a>
    <div class="sep"></div>
    <a href="#type-system">타입 시스템</a>
    <a href="#email-summary-spec">email_summary 규격</a>
    <a href="#edge-cases">엣지 케이스</a>
    <a href="#roadmap">구현 로드맵</a>
    <div class="sep"></div>
    <a href="#unified-knowledge">통합 지식 서비스</a>
    <a href="#rag-evolution">Layer 0 진화 로드맵</a>
  </nav>
</aside>

<!-- ============================== Main ============================== -->
<div class="main">

  <!-- Header -->
  <section id="header">
    <h1>콘텐츠 파이프라인 v3 아키텍처 보고서</h1>
    <p style="font-size:16px;font-weight:600;color:var(--primary);margin-bottom:4px;">QA 이슈 5건 해소 + RAG 연결 + 미리보기 검증 단계 신설</p>
    <div class="meta">
      <span>작성일: 2026-02-15</span>
      <span>작성: leader (에이전트)</span>
      <span>대상: 콘텐츠 생성 &rarr; 검토 &rarr; 뉴스레터 발송 파이프라인</span>
      <span><span class="badge badge-proposed">PROPOSED</span></span>
    </div>
  </section>

  <!-- 1. 요약 -->
  <h2 id="executive-summary">1. 요약 (Executive Summary)</h2>

  <div class="summary-box">
    <strong>핵심:</strong> 현재 콘텐츠 파이프라인(v2.1)에서 QA를 통해 발견된 <strong>5건의 구조적 갭</strong>을 해소하는
    v3 아키텍처를 제안합니다. 가장 큰 변화는 <strong>RAG 컨텍스트를 콘텐츠 생성 프롬프트에 주입</strong>하는 것과,
    발송 전 <strong>미리보기+품질 검증 단계(LAYER 1b)</strong>를 신설하는 것입니다.
  </div>

  <p>
    v2.1 파이프라인은 4개 계층(RAG 인프라 &rarr; AI 생성 &rarr; 템플릿 빌드 &rarr; 배포)으로 구성되어 있으나,
    RAG와 생성 계층 사이가 <strong>연결되지 않아</strong> 강의 자료 기반 콘텐츠 생성이 불가능합니다.
    또한 <code>webinar</code> 타입이 <code>notice</code> 템플릿(B)에 매핑되는 버그,
    <code>email_summary</code>에 배너 구조(### 헤딩)가 포함되지 않는 문제 등이 있습니다.
  </p>
  <p>
    v3은 이 갭들을 최소 변경(~260줄, 파일 3~5개)으로 해소하며,
    기존 인프라(pgvector, Gemini, Claude, Unlayer, Resend)를 100% 재활용합니다.
    P0(즉시)~P2(3~5일) 3단계 로드맵으로 점진 적용합니다.
  </p>

  <div class="impact-grid">
    <div class="impact-card">
      <div class="num">5</div>
      <div class="label">QA 이슈 해소</div>
    </div>
    <div class="impact-card">
      <div class="num">~260</div>
      <div class="label">변경 줄 수 (예상)</div>
    </div>
    <div class="impact-card">
      <div class="num">3~5</div>
      <div class="label">수정 파일 수</div>
    </div>
  </div>

  <!-- 2. 현재 아키텍처 -->
  <h2 id="current-architecture">2. 현재 아키텍처 (v2.1)</h2>

  <p>현재 파이프라인은 4개 계층으로 구성됩니다. 각 계층은 독립적으로 동작하지만, <strong>LAYER 0a와 LAYER 1a 사이가 단절</strong>되어 있습니다.</p>

  <table>
    <thead>
      <tr><th>계층</th><th>역할</th><th>핵심 모듈</th><th>상태</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><span class="layer-tag layer-0a">LAYER 0a</span> RAG 인프라</td>
        <td>강의 청크 임베딩 + 벡터 검색</td>
        <td><code>gemini.ts</code>, <code>rag.ts</code></td>
        <td><span class="badge badge-ok">정상</span></td>
      </tr>
      <tr>
        <td><span class="layer-tag layer-1a">LAYER 1a</span> AI 생성</td>
        <td>Claude API로 콘텐츠 생성</td>
        <td><code>contents.ts</code> L623-698</td>
        <td><span class="badge badge-warn">RAG 미연결</span></td>
      </tr>
      <tr>
        <td><span class="layer-tag layer-2">LAYER 2a</span> 템플릿 빌드</td>
        <td>email_summary &rarr; Unlayer JSON &rarr; HTML</td>
        <td><code>email-template-utils.ts</code></td>
        <td><span class="badge badge-warn">타입 매핑 버그</span></td>
      </tr>
      <tr>
        <td><span class="layer-tag layer-2">LAYER 2b</span> 배포</td>
        <td>Unlayer &rarr; HTML export &rarr; Resend SMTP</td>
        <td><code>newsletter-edit-panel.tsx</code></td>
        <td><span class="badge badge-ok">정상</span></td>
      </tr>
    </tbody>
  </table>

  <h3>핵심 파일 맵</h3>
  <table>
    <thead>
      <tr><th>파일</th><th>핵심 함수/상수</th><th>라인</th><th>역할</th></tr>
    </thead>
    <tbody>
      <tr><td><code>src/lib/gemini.ts</code></td><td><code>generateEmbedding()</code></td><td>L15-38</td><td>text-embedding-004로 768차원 벡터 생성</td></tr>
      <tr><td><code>src/lib/gemini.ts</code></td><td><code>generateAnswer()</code></td><td>L44-90</td><td>gemini-2.5-flash로 RAG 답변 생성 (QA용)</td></tr>
      <tr><td><code>src/lib/rag.ts</code></td><td><code>searchRelevantChunks()</code></td><td>L26-50</td><td>pgvector RPC로 유사도 검색 (threshold 0.5)</td></tr>
      <tr><td><code>src/lib/rag.ts</code></td><td><code>generateRAGAnswer()</code></td><td>L55-98</td><td>청크 검색 &rarr; Gemini 답변 (QA 전용)</td></tr>
      <tr><td><code>src/actions/contents.ts</code></td><td><code>TYPE_PROMPTS</code></td><td>L519-621</td><td>5개 타입별 system/user/emailSummaryGuide</td></tr>
      <tr><td><code>src/actions/contents.ts</code></td><td><code>generateContentWithAI()</code></td><td>L623-698</td><td>Claude Sonnet 4로 콘텐츠 + emailSummary 생성</td></tr>
      <tr><td><code>src/lib/email-template-utils.ts</code></td><td><code>BANNER_MAP</code></td><td>L6-20</td><td>13개 ### 헤딩 &rarr; 배너 이미지 매핑</td></tr>
      <tr><td><code>src/lib/email-template-utils.ts</code></td><td><code>buildDesignFromSummary()</code></td><td>L250-351</td><td>email_summary &rarr; Unlayer 디자인 JSON 빌드</td></tr>
      <tr><td><code>src/components/content/new-content-modal.tsx</code></td><td>FlowStep UI</td><td>L1-375</td><td>select &rarr; url/ai/upload &rarr; createContent</td></tr>
      <tr><td><code>src/components/content/newsletter-edit-panel.tsx</code></td><td>Unlayer + send</td><td>L56-298</td><td>디자인 편집 &rarr; 테스트/본 발송</td></tr>
    </tbody>
  </table>

  <h3>함수 체인 (v2.1)</h3>
  <pre><code>new-content-modal.tsx &rarr; handleGenerate()
  &rarr; generateContentWithAI(topic, type)       // contents.ts:623
      &rarr; Claude API (system: TYPE_PROMPTS[type].system)
      &rarr; {title, bodyMd, emailSummary}
  &rarr; createContent({...})                     // contents.ts:140
      &rarr; Supabase insert (contents 테이블)

newsletter-edit-panel.tsx &rarr; buildDesignFromSummary(content)
  &rarr; type&rarr;template 매핑 (education&rarr;A, notice&rarr;B, case_study&rarr;C, 기타&rarr;Default)
  &rarr; markdownToEmailHtml(email_summary)       // email-template-utils.ts:27
      &rarr; ### &rarr; BANNER_MAP 매칭 &rarr; 배너 이미지/gradient
  &rarr; Unlayer 에디터 로드
  &rarr; exportHtml() &rarr; Resend SMTP 발송</code></pre>

  <!-- 3. QA 이슈 5건 -->
  <h2 id="qa-issues">3. QA 이슈 5건</h2>

  <!-- 이슈 1 -->
  <div class="issue-card">
    <div class="issue-header">
      <span class="issue-num">1</span>
      <span class="issue-title">RAG 컨텍스트가 콘텐츠 생성에 미연결</span>
      <span class="badge badge-danger">Critical</span>
    </div>
    <div class="issue-meta">
      <code>src/actions/contents.ts</code> L623-698 &nbsp;|&nbsp;
      <code>src/lib/rag.ts</code> L26-50
    </div>
    <h4>현재 (v2.1)</h4>
    <p><code>generateContentWithAI()</code>는 Claude API를 직접 호출하며, <code>searchRelevantChunks()</code>를 전혀 호출하지 않습니다.
      RAG 인프라(LAYER 0a)가 QA 답변 전용으로만 사용되고, 콘텐츠 생성과 단절되어 있습니다.</p>
    <h4>기대 (v3)</h4>
    <p>콘텐츠 생성 시 <code>topic</code>을 임베딩 &rarr; <code>searchRelevantChunks()</code>로 관련 강의 청크 검색 &rarr;
      검색된 청크를 Claude system prompt에 &quot;참고 강의 자료&quot;로 주입합니다.
      이를 통해 강의 내용 기반의 정확한 콘텐츠가 생성됩니다.</p>
  </div>

  <!-- 이슈 2 -->
  <div class="issue-card">
    <div class="issue-header">
      <span class="issue-num">2</span>
      <span class="issue-title">webinar 타입이 notice 템플릿(B)에 매핑됨</span>
      <span class="badge badge-warn">Major</span>
    </div>
    <div class="issue-meta">
      <code>src/lib/email-template-utils.ts</code> L250-260
    </div>
    <h4>현재 (v2.1)</h4>
    <pre><code>const baseTemplate =
  content.type === "notice"    ? BS_CAMP_TEMPLATE_B    // &larr; notice &rarr; B
  : content.type === "case_study" ? BS_CAMP_TEMPLATE_C
  : content.type === "education"  ? BS_CAMP_TEMPLATE_A
  : BS_CAMP_DEFAULT_TEMPLATE;                          // &larr; webinar, promo &rarr; Default</code></pre>
    <p><code>webinar</code>는 히어로 블록이 있는 <strong>Template B</strong>가 적합한데, <code>notice</code>가 B를 차지하고 있어
      <code>webinar</code>가 Default로 빠집니다. Template B의 히어로 블록(<code>content-hero</code>)은 웨비나 제목/부제목 렌더링에 최적화되어 있습니다.</p>
    <h4>기대 (v3)</h4>
    <p><code>webinar &rarr; B</code>, <code>notice &rarr; Default(또는 신규 D)</code>로 매핑을 교정합니다.
      매핑 로직을 <strong>상수 테이블</strong>로 분리하여 가독성과 확장성을 확보합니다.</p>
  </div>

  <!-- 이슈 3 -->
  <div class="issue-card">
    <div class="issue-header">
      <span class="issue-num">3</span>
      <span class="issue-title">email_summary에 배너 구조(### 헤딩)가 미포함</span>
      <span class="badge badge-warn">Major</span>
    </div>
    <div class="issue-meta">
      <code>src/actions/contents.ts</code> L519-621 (TYPE_PROMPTS.emailSummaryGuide) &nbsp;|&nbsp;
      <code>src/lib/email-template-utils.ts</code> L82-96 (### 배너 파싱)
    </div>
    <h4>현재 (v2.1)</h4>
    <p><code>TYPE_PROMPTS[type].emailSummaryGuide</code>는 &quot;핵심 포인트 3~4개를 넘버링&quot;처럼 추상적인 지시만 포함합니다.
      실제 <code>markdownToEmailHtml()</code>이 인식하는 <code>### INSIGHT</code>, <code>### CHECKLIST</code> 등의
      배너 헤딩이 가이드에 없어, AI가 생성한 email_summary에 배너 이미지가 렌더링되지 않습니다.</p>
    <h4>기대 (v3)</h4>
    <p><code>emailSummaryGuide</code>에 타입별 필수 <code>###</code> 헤딩 목록을 명시합니다.
      예: education은 <code>### INSIGHT</code>, <code>### KEY POINT</code>, <code>### CHECKLIST</code>를 필수로 포함.</p>
  </div>

  <!-- 이슈 4 -->
  <div class="issue-card">
    <div class="issue-header">
      <span class="issue-num">4</span>
      <span class="issue-title">발송 전 검토/미리보기 단계 부재</span>
      <span class="badge badge-info">Enhancement</span>
    </div>
    <div class="issue-meta">
      <code>src/components/content/new-content-modal.tsx</code> L155-173 &nbsp;|&nbsp;
      <code>src/components/content/newsletter-edit-panel.tsx</code> L56-298
    </div>
    <h4>현재 (v2.1)</h4>
    <p>AI 생성 &rarr; DB 저장이 즉시 수행됩니다. 생성된 콘텐츠의 email_summary가 배너/체크리스트 구조에 적합한지
      확인하는 단계가 없어, Unlayer 에디터를 열어봐야 결과를 알 수 있습니다.</p>
    <h4>기대 (v3)</h4>
    <p>모달 내 &quot;생성 완료&quot; 스텝을 추가하여, email_summary의 ### 헤딩 분석 결과와
      예상 배너 매칭 상태를 미리보기로 표시합니다. 문제가 있으면 재생성 가능.</p>
  </div>

  <!-- 이슈 5 -->
  <div class="issue-card">
    <div class="issue-header">
      <span class="issue-num">5</span>
      <span class="issue-title">프롬프트에 BANNER_MAP/타입 정보 부재</span>
      <span class="badge badge-info">Enhancement</span>
    </div>
    <div class="issue-meta">
      <code>src/actions/contents.ts</code> L519-621 (TYPE_PROMPTS)
    </div>
    <h4>현재 (v2.1)</h4>
    <p>Claude system prompt에 BANNER_MAP 키 목록이 포함되지 않아, AI가 <code>### INSIGHT</code> 대신
      <code>### 핵심 인사이트</code> 같은 자유 형식을 사용합니다. 이는 배너 매칭 실패를 야기합니다.</p>
    <h4>기대 (v3)</h4>
    <p><code>emailSummaryGuide</code>에 BANNER_MAP의 정확한 키 목록과 사용 규칙을 포함합니다.
      RAG 컨텍스트와 함께 토큰 예산(3,000자)을 명시하여 길이 제어도 병행합니다.</p>
  </div>

  <!-- 4. v3 아키텍처 -->
  <h2 id="v3-architecture">4. v3 아키텍처</h2>

  <p>v3은 기존 4계층에 <strong>LAYER 0b (RAG Bridge)</strong>와 <strong>LAYER 1b (Preview+Validation)</strong>를 추가한 <strong>5계층</strong> 구조입니다.</p>

  <table>
    <thead>
      <tr><th>계층</th><th>v2.1</th><th>v3 변경</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><span class="layer-tag layer-0a">LAYER 0a</span> RAG 인프라</td>
        <td>QA 답변 전용</td>
        <td>변경 없음 (그대로 활용)</td>
      </tr>
      <tr>
        <td><span class="layer-tag layer-0b">LAYER 0b</span> RAG Bridge <span class="badge badge-danger">NEW</span></td>
        <td>-</td>
        <td><code>searchRelevantChunks()</code> &rarr; 콘텐츠 생성 프롬프트에 주입</td>
      </tr>
      <tr>
        <td><span class="layer-tag layer-1a">LAYER 1a</span> AI 생성</td>
        <td>Claude 단독 생성</td>
        <td>system prompt에 RAG 컨텍스트 + emailSummaryGuide 강화</td>
      </tr>
      <tr>
        <td><span class="layer-tag layer-1b">LAYER 1b</span> 미리보기+검증 <span class="badge badge-danger">NEW</span></td>
        <td>-</td>
        <td>email_summary 구조 검증 + 배너 매칭 미리보기</td>
      </tr>
      <tr>
        <td><span class="layer-tag layer-2">LAYER 2</span> 템플릿 빌드+배포</td>
        <td>타입 매핑 버그</td>
        <td>매핑 상수 교정 (webinar&rarr;B), CTA 텍스트 통합</td>
      </tr>
    </tbody>
  </table>

  <h3>변경 요약</h3>
  <ul>
    <li><strong>RAG 연결 (0b):</strong> <code>generateContentWithAI()</code> 내에서 <code>searchRelevantChunks(topic)</code> 호출 &rarr; 결과를 system prompt에 주입</li>
    <li><strong>emailSummaryGuide 강화 (1a):</strong> BANNER_MAP 키 목록, 타입별 필수 ### 헤딩, 토큰 예산(3,000자) 명시</li>
    <li><strong>미리보기 (1b):</strong> new-content-modal에 &quot;preview&quot; 스텝 추가 &rarr; ### 헤딩 분석 &rarr; 배너 매칭 시각화</li>
    <li><strong>타입 매핑 (2):</strong> <code>TYPE_TO_TEMPLATE</code> 상수 분리 &rarr; webinar&rarr;B, notice&rarr;Default로 교정</li>
    <li><strong>CTA 텍스트 (2):</strong> webinar: &quot;지금 등록하기&quot;, promo: &quot;혜택 확인하기&quot; 추가</li>
  </ul>

  <!-- 5. 컴포넌트 다이어그램 -->
  <h2 id="diagram-component">5. 컴포넌트 다이어그램</h2>

  <p>5개 계층의 모듈 의존 관계입니다. <span style="color:var(--primary);font-weight:600;">빨간 점선</span>은 v3에서 신규 추가되는 연결입니다.</p>

  <pre class="mermaid">
graph TB
  subgraph LAYER_0a["LAYER 0a &#8212; RAG 인프라"]
    LC["lecture_chunks\n(pgvector)"]
    GE["Gemini\ntext-embedding-004"]
    SRC["searchRelevantChunks()"]
    LC -->|"embedding"| GE
    GE -->|"768-dim vector"| LC
    LC -->|"RPC match"| SRC
  end

  subgraph LAYER_0b["LAYER 0b &#8212; RAG Bridge (NEW)"]
    RB["RAG Context\nBuilder"]
    SRC -->|"LectureChunk[]"| RB
  end

  subgraph LAYER_1a["LAYER 1a &#8212; AI 생성"]
    TP["TYPE_PROMPTS\n(5 types)"]
    CL["Claude Sonnet 4\n(Anthropic API)"]
    GEN["generateContentWithAI()"]
    TP -->|"system + guide"| GEN
    RB -.->|"RAG context"| GEN
    GEN -->|"API call"| CL
    CL -->|"title + bodyMd + emailSummary"| GEN
  end

  subgraph LAYER_1b["LAYER 1b &#8212; 미리보기 (NEW)"]
    PV["Preview Step"]
    VA["Heading Validator"]
    GEN -.->|"emailSummary"| PV
    PV --> VA
  end

  subgraph LAYER_2["LAYER 2 &#8212; 템플릿 빌드 + 배포"]
    BM["BANNER_MAP\n(13 keys)"]
    BD["buildDesignFromSummary()"]
    MH["markdownToEmailHtml()"]
    UL["Unlayer Editor"]
    RS["Resend SMTP"]
    BD -->|"email_summary"| MH
    MH -->|"### parse"| BM
    BD -->|"Unlayer JSON"| UL
    UL -->|"HTML export"| RS
  end

  GEN -->|"DB insert"| DB[(Supabase\ncontents)]
  DB -->|"content load"| BD

  style LAYER_0b fill:#E0E7FF,stroke:#3730A3,stroke-width:2px
  style LAYER_1b fill:#FFEDD5,stroke:#9A3412,stroke-width:2px
  style RB fill:#E0E7FF,stroke:#3730A3
  style PV fill:#FFEDD5,stroke:#9A3412
  style VA fill:#FFEDD5,stroke:#9A3412
  </pre>

  <!-- 6. 시퀀스 다이어그램 -->
  <h2 id="diagram-sequence">6. 시퀀스 다이어그램</h2>

  <p>웨비나 콘텐츠 생성부터 뉴스레터 발송까지의 전체 흐름입니다. <span style="color:var(--primary);font-weight:600;">v3 신규</span> 단계가 표시됩니다.</p>

  <pre class="mermaid">
sequenceDiagram
  actor User as 관리자
  participant Modal as NewContentModal
  participant RAG as searchRelevantChunks
  participant Claude as Claude Sonnet 4
  participant Preview as Preview Step (v3)
  participant DB as Supabase DB
  participant Builder as buildDesignFromSummary
  participant Unlayer as Unlayer Editor
  participant SMTP as Resend SMTP

  User->>Modal: 타입 선택 (webinar) + 주제 입력
  Modal->>RAG: topic 임베딩 > 벡터 검색 (v3)
  RAG-->>Modal: LectureChunk[] (top 5)

  Modal->>Claude: system prompt + RAG context + guide
  Claude-->>Modal: title, bodyMd, emailSummary

  Note over Modal,Preview: v3 미리보기 단계
  Modal->>Preview: emailSummary 구조 분석
  Preview-->>Modal: 헤딩 매칭 결과 표시
  User->>Modal: 확인 (또는 재생성)

  Modal->>DB: createContent(...)
  DB-->>Modal: content.id

  Note over User,Unlayer: 뉴스레터 편집 단계
  User->>Builder: 뉴스레터 탭 열기
  Builder->>Builder: type>template 매핑 (webinar>B)
  Builder->>Builder: markdownToEmailHtml(email_summary)
  Builder-->>Unlayer: Unlayer JSON 로드

  User->>Unlayer: 편집 + 저장
  User->>SMTP: 발송하기 클릭
  Unlayer->>SMTP: HTML export > 발송
  SMTP-->>User: 발송 완료
  </pre>

  <!-- 7. 데이터 흐름도 -->
  <h2 id="diagram-dataflow">7. 데이터 흐름도</h2>

  <p>데이터가 각 계층을 통과하며 변환되는 과정입니다.</p>

  <pre class="mermaid">
graph LR
  subgraph Input["입력"]
    T["topic (사용자)"]
    TY["type (5종)"]
  end

  subgraph RAG_Search["RAG 검색 (v3)"]
    EMB["generateEmbedding\n(topic)"]
    VS["pgvector\nmatch_lecture_chunks"]
    CHK["LectureChunk[]"]
    T --> EMB --> VS --> CHK
  end

  subgraph Generation["AI 생성"]
    TP2["TYPE_PROMPTS"]
    SYS["system prompt\n+ RAG context\n+ emailSummaryGuide"]
    CL2["Claude Sonnet 4"]
    OUT["title + bodyMd\n+ emailSummary"]
    TY --> TP2 --> SYS
    CHK -.->|"v3"| SYS
    SYS --> CL2 --> OUT
  end

  subgraph Render["렌더링"]
    ES["emailSummary"]
    HP["### 파싱"]
    BMP["BANNER_MAP\n매칭"]
    IMG["배너 이미지\n/ gradient"]
    TPL["Template\nA/B/C/Default"]
    UJ["Unlayer JSON"]
    HT["HTML"]
    SM["Resend SMTP"]
    OUT --> ES --> HP --> BMP --> IMG
    TY -->|"type>template"| TPL
    IMG --> TPL --> UJ --> HT --> SM
  end

  style RAG_Search fill:#E0E7FF,stroke:#3730A3,stroke-width:2px
  </pre>

  <!-- 8. ADR-1 -->
  <h2 id="adr-1">8. ADR-1: RAG 주입 위치</h2>

  <div class="adr">
    <div class="adr-header">
      <span class="adr-num">ADR-1</span>
      <span class="adr-title">RAG 컨텍스트를 콘텐츠 생성 프롬프트에 주입하는 위치</span>
    </div>
    <div class="adr-body">
      <div class="adr-section">
        <div class="adr-section-title">맥락 (Context)</div>
        <p>현재 <code>generateContentWithAI()</code>(contents.ts:623)는 Claude API를 호출할 때 <code>TYPE_PROMPTS[type].system</code>만 전달합니다.
          <code>searchRelevantChunks()</code>(rag.ts:26)는 존재하지만 QA 답변 생성(rag.ts:55)에서만 사용됩니다.
          콘텐츠 생성에 강의 자료를 활용하려면 RAG 컨텍스트를 어딘가에 주입해야 합니다.</p>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">선택지 (Options)</div>
        <table>
          <thead><tr><th>옵션</th><th>설명</th><th>장점</th><th>단점</th></tr></thead>
          <tbody>
            <tr><td><strong>A. system prompt에 주입</strong></td><td>system 메시지에 &quot;참고 강의 자료&quot; 섹션 추가</td><td>Claude가 전체 대화에서 참조 가능, 구현 간단</td><td>system 토큰 증가 (~2,000자)</td></tr>
            <tr><td>B. user message에 주입</td><td>user 메시지 앞에 RAG 컨텍스트 추가</td><td>system prompt 변경 불필요</td><td>topic과 RAG가 혼재, 우선순위 불명확</td></tr>
            <tr><td>C. 별도 pre-processing</td><td>RAG로 초안 생성 후 Claude가 리라이트</td><td>2단계 품질 보장</td><td>API 호출 2회, 지연 2배, 비용 2배</td></tr>
          </tbody>
        </table>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결정 (Decision)</div>
        <p><strong>옵션 A: system prompt에 주입</strong>을 선택합니다.</p>
        <p>이유: (1) 기존 <code>generateRAGAnswer()</code>가 동일한 패턴(system prompt에 강의 자료 컨텍스트 전달)을 사용하고 있어 일관성 유지,
          (2) 단일 API 호출로 지연/비용 최소화,
          (3) <code>searchRelevantChunks()</code>를 그대로 재사용 가능.</p>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결과 (Consequences)</div>
        <div class="consequence"><span class="plus">[+]</span> 기존 RAG 인프라 100% 재활용, 신규 모듈 불필요</div>
        <div class="consequence"><span class="plus">[+]</span> 강의 내용 기반 정확한 콘텐츠 생성 가능</div>
        <div class="consequence"><span class="minus">[-]</span> system prompt 토큰 ~2,000자 증가 (비용 미미)</div>
        <div class="consequence"><span class="neutral">[~]</span> 관련 청크가 없을 때 fallback 필요 (빈 배열 &rarr; 기존 동작 유지)</div>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">관련 코드</div>
        <p><code>src/actions/contents.ts:623-698</code> &mdash; generateContentWithAI() 수정 대상<br>
          <code>src/lib/rag.ts:26-50</code> &mdash; searchRelevantChunks() 재사용<br>
          <code>src/lib/gemini.ts:15-38</code> &mdash; generateEmbedding() 재사용</p>
      </div>
    </div>
  </div>

  <!-- 9. ADR-2 -->
  <h2 id="adr-2">9. ADR-2: 타입&rarr;템플릿 매핑 통합</h2>

  <div class="adr">
    <div class="adr-header">
      <span class="adr-num">ADR-2</span>
      <span class="adr-title">content.type &rarr; email template 매핑 방식</span>
    </div>
    <div class="adr-body">
      <div class="adr-section">
        <div class="adr-section-title">맥락 (Context)</div>
        <p><code>buildDesignFromSummary()</code>(email-template-utils.ts:250)에서 <code>content.type</code>에 따라 템플릿을 선택합니다.
          현재 <code>notice &rarr; B</code>로 매핑되어 있는데, Template B는 히어로 블록(<code>content-hero</code>)이 있어
          <code>webinar</code>에 더 적합합니다. <code>webinar</code>는 Default로 빠져 히어로 블록을 활용하지 못합니다.</p>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">선택지 (Options)</div>
        <table>
          <thead><tr><th>옵션</th><th>설명</th><th>장점</th><th>단점</th></tr></thead>
          <tbody>
            <tr><td><strong>A. 매핑 상수 분리</strong></td><td><code>TYPE_TO_TEMPLATE</code> Record로 매핑 관리</td><td>가독성 높음, 확장 용이, 테스트 쉬움</td><td>기존 조건분기 제거 필요</td></tr>
            <tr><td>B. if-else 수정만</td><td>기존 조건분기에서 webinar 분기 추가</td><td>최소 변경</td><td>확장성 낮음, 가독성 악화</td></tr>
            <tr><td>C. DB에 매핑 저장</td><td>contents 테이블에 template_type 컬럼 추가</td><td>런타임 변경 가능</td><td>마이그레이션 필요, 과도한 엔지니어링</td></tr>
          </tbody>
        </table>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결정 (Decision)</div>
        <p><strong>옵션 A: 매핑 상수 분리</strong>를 선택합니다.</p>
        <pre><code>const TYPE_TO_TEMPLATE: Record&lt;string, object&gt; = {
  education:  BS_CAMP_TEMPLATE_A,
  webinar:    BS_CAMP_TEMPLATE_B,   // 히어로 블록 활용
  case_study: BS_CAMP_TEMPLATE_C,
  notice:     BS_CAMP_DEFAULT_TEMPLATE,
  promo:      BS_CAMP_DEFAULT_TEMPLATE,
};</code></pre>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결과 (Consequences)</div>
        <div class="consequence"><span class="plus">[+]</span> webinar가 히어로 블록을 활용해 시각적 임팩트 강화</div>
        <div class="consequence"><span class="plus">[+]</span> 신규 타입 추가 시 한 줄만 추가하면 됨</div>
        <div class="consequence"><span class="minus">[-]</span> notice 템플릿이 Default로 변경 &rarr; 기존 notice 뉴스레터 디자인 변경</div>
        <div class="consequence"><span class="neutral">[~]</span> CTA 텍스트도 동일 패턴으로 상수화 가능</div>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">관련 코드</div>
        <p><code>src/lib/email-template-utils.ts:250-260</code> &mdash; buildDesignFromSummary() 매핑 수정</p>
      </div>
    </div>
  </div>

  <!-- 10. ADR-3 -->
  <h2 id="adr-3">10. ADR-3: email_summary 검증 전략</h2>

  <div class="adr">
    <div class="adr-header">
      <span class="adr-num">ADR-3</span>
      <span class="adr-title">email_summary 구조 검증: soft + hard 병행</span>
    </div>
    <div class="adr-body">
      <div class="adr-section">
        <div class="adr-section-title">맥락 (Context)</div>
        <p>AI가 생성한 <code>email_summary</code>는 <code>markdownToEmailHtml()</code>에 의해 파싱됩니다.
          이 파서는 <code>### 헤딩</code>을 배너 이미지로 변환하는데, 헤딩이 없거나 BANNER_MAP에 없는 키를 사용하면
          gradient fallback이 적용됩니다. 현재는 검증 로직이 전혀 없습니다.</p>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">선택지 (Options)</div>
        <table>
          <thead><tr><th>옵션</th><th>설명</th><th>장점</th><th>단점</th></tr></thead>
          <tbody>
            <tr><td>A. hard validation만</td><td>필수 헤딩 없으면 재생성 강제</td><td>품질 보장</td><td>재생성 비용/지연, UX 저하</td></tr>
            <tr><td><strong>B. soft + hard 병행</strong></td><td>soft: 경고 + 수동 수정, hard: 최소 1개 ### 필수</td><td>유연성 + 최소 품질 보장</td><td>검증 UI 구현 필요</td></tr>
            <tr><td>C. 검증 없음 (현재)</td><td>파서에 맡김</td><td>구현 비용 0</td><td>품질 보장 불가</td></tr>
          </tbody>
        </table>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결정 (Decision)</div>
        <p><strong>옵션 B: soft + hard 병행</strong>을 선택합니다.</p>
        <ul>
          <li><strong>Hard:</strong> email_summary에 최소 1개의 <code>###</code> 헤딩이 있어야 함 (없으면 경고 + 재생성 권유)</li>
          <li><strong>Soft:</strong> BANNER_MAP에 매칭되지 않는 헤딩은 경고 표시 (gradient fallback 안내), 저장은 허용</li>
        </ul>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결과 (Consequences)</div>
        <div class="consequence"><span class="plus">[+]</span> 배너 없는 뉴스레터 발송 방지 (최소 1개 보장)</div>
        <div class="consequence"><span class="plus">[+]</span> gradient fallback이 의도적 선택인지 사고인지 구분 가능</div>
        <div class="consequence"><span class="minus">[-]</span> Preview 스텝 UI 구현 비용 (~80줄)</div>
        <div class="consequence"><span class="neutral">[~]</span> 향후 자동 수정(AI 재작성) 확장 가능</div>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">관련 코드</div>
        <p><code>src/components/content/new-content-modal.tsx</code> &mdash; Preview 스텝 추가<br>
          <code>src/lib/email-template-utils.ts:6-20</code> &mdash; BANNER_MAP 키 참조</p>
      </div>
    </div>
  </div>

  <!-- 11. ADR-4 -->
  <h2 id="adr-4">11. ADR-4: 미리보기 UX</h2>

  <div class="adr">
    <div class="adr-header">
      <span class="adr-num">ADR-4</span>
      <span class="adr-title">미리보기 UX: 모달 내 step 방식</span>
    </div>
    <div class="adr-body">
      <div class="adr-section">
        <div class="adr-section-title">맥락 (Context)</div>
        <p>현재 <code>new-content-modal.tsx</code>는 <code>FlowStep</code> 타입으로 &quot;select&quot; | &quot;url&quot; | &quot;ai&quot; | &quot;upload&quot; 4개 스텝을 관리합니다(L39).
          AI 생성 후 바로 DB에 저장되므로, 생성 결과를 확인할 기회가 없습니다.
          미리보기를 어디에 배치할지 결정해야 합니다.</p>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">선택지 (Options)</div>
        <table>
          <thead><tr><th>옵션</th><th>설명</th><th>장점</th><th>단점</th></tr></thead>
          <tbody>
            <tr><td><strong>A. 모달 내 step 추가</strong></td><td>FlowStep에 &quot;preview&quot; 추가, AI 생성 완료 후 전환</td><td>기존 UX 패턴 유지, 구현 간단</td><td>모달 크기 제한 (~540px)</td></tr>
            <tr><td>B. 별도 페이지</td><td>생성 후 상세 페이지로 이동하여 미리보기</td><td>넓은 화면</td><td>기존 플로우 변경 크고, 라우팅 추가 필요</td></tr>
            <tr><td>C. 토스트 알림만</td><td>헤딩 매칭 결과를 토스트로 표시</td><td>구현 최소</td><td>정보 부족, 재생성 불가</td></tr>
          </tbody>
        </table>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결정 (Decision)</div>
        <p><strong>옵션 A: 모달 내 step 추가</strong>를 선택합니다.</p>
        <p><code>FlowStep</code>에 <code>&quot;preview&quot;</code>를 추가하고, AI 생성 완료 후 자동 전환합니다.
          미리보기 스텝에서는: (1) 제목/본문 미리보기, (2) email_summary의 ### 헤딩 목록과 BANNER_MAP 매칭 상태,
          (3) &quot;저장&quot; / &quot;재생성&quot; 버튼을 표시합니다.</p>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결과 (Consequences)</div>
        <div class="consequence"><span class="plus">[+]</span> 기존 FlowStep 패턴과 일관된 UX</div>
        <div class="consequence"><span class="plus">[+]</span> 모달 안에서 완결되므로 라우팅 변경 불필요</div>
        <div class="consequence"><span class="minus">[-]</span> 540px 모달 내 정보 밀도 &rarr; 스크롤 가능성</div>
        <div class="consequence"><span class="neutral">[~]</span> 모달 폭을 640px로 확장하면 해소 가능</div>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">관련 코드</div>
        <p><code>src/components/content/new-content-modal.tsx:39</code> &mdash; FlowStep 타입 확장<br>
          <code>src/components/content/new-content-modal.tsx:155-173</code> &mdash; handleGenerate() 수정</p>
      </div>
    </div>
  </div>

  <!-- 12. ADR-5 -->
  <h2 id="adr-5">12. ADR-5: 토큰 예산 전략</h2>

  <div class="adr">
    <div class="adr-header">
      <span class="adr-num">ADR-5</span>
      <span class="adr-title">RAG 컨텍스트 토큰 예산: 고정 3,000자 + 유사도 우선</span>
    </div>
    <div class="adr-body">
      <div class="adr-section">
        <div class="adr-section-title">맥락 (Context)</div>
        <p>RAG 컨텍스트를 system prompt에 주입하면 토큰 사용량이 증가합니다. Claude Sonnet 4의 입력 토큰 제한(200K)은
          충분하지만, 비용과 응답 품질을 고려해 적절한 예산을 설정해야 합니다.
          현재 <code>searchRelevantChunks()</code>는 기본 limit=5, threshold=0.5을 사용합니다.</p>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">선택지 (Options)</div>
        <table>
          <thead><tr><th>옵션</th><th>설명</th><th>장점</th><th>단점</th></tr></thead>
          <tbody>
            <tr><td><strong>A. 고정 3,000자 + 유사도 우선</strong></td><td>상위 N개 청크를 유사도 순으로 3,000자까지 포함</td><td>예측 가능, 구현 간단, 비용 고정</td><td>긴 청크 1개가 예산 독차지 가능</td></tr>
            <tr><td>B. 동적 예산</td><td>유사도에 따라 가변적으로 청크 수 결정</td><td>정밀한 예산 제어</td><td>복잡한 구현, 예측 어려움</td></tr>
            <tr><td>C. 전체 포함</td><td>검색된 청크 전부 포함</td><td>구현 최소</td><td>토큰 폭주 가능, 비용 미예측</td></tr>
          </tbody>
        </table>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결정 (Decision)</div>
        <p><strong>옵션 A: 고정 3,000자 + 유사도 우선</strong>을 선택합니다.</p>
        <pre><code>// generateContentWithAI() 내부
const chunks = await searchRelevantChunks(topic, 5, 0.4);
let ragContext = "";
let charCount = 0;
const RAG_BUDGET = 3000;
for (const chunk of chunks) {
  if (charCount + chunk.content.length > RAG_BUDGET) break;
  ragContext += `[${chunk.lecture_name}] ${chunk.content}\n\n`;
  charCount += chunk.content.length;
}</code></pre>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결과 (Consequences)</div>
        <div class="consequence"><span class="plus">[+]</span> 토큰 비용 예측 가능 (~1,500 토큰 추가)</div>
        <div class="consequence"><span class="plus">[+]</span> 유사도 순이므로 가장 관련 높은 청크 우선 포함</div>
        <div class="consequence"><span class="minus">[-]</span> 3,000자 미만 청크만 있으면 예산 미달 (문제 아님)</div>
        <div class="consequence"><span class="neutral">[~]</span> 예산은 향후 A/B 테스트로 조정 가능</div>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">관련 코드</div>
        <p><code>src/actions/contents.ts:623-698</code> &mdash; generateContentWithAI() 내 RAG 주입 구현</p>
      </div>
    </div>
  </div>

  <!-- 13. 타입 시스템 -->
  <h2 id="type-system">13. 타입 시스템 (type &rarr; template 매핑)</h2>

  <p>v3에서 교정된 매핑 테이블입니다. <span class="badge badge-danger">변경</span> 표시는 v2.1 대비 변경된 항목입니다.</p>

  <table>
    <thead>
      <tr><th>content.type</th><th>v2.1 템플릿</th><th>v3 템플릿</th><th>CTA 텍스트</th><th>특수 처리</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><code>education</code></td><td>A</td><td>A</td><td>전체 가이드 보기</td><td>-</td>
      </tr>
      <tr style="background:#FEF2F2;">
        <td><code>webinar</code> <span class="badge badge-danger">변경</span></td><td>Default</td><td><strong>B</strong></td><td><strong>지금 등록하기</strong></td><td>content-hero 히어로 블록 활용, row-title/row-hook-quote 제거</td>
      </tr>
      <tr>
        <td><code>case_study</code></td><td>C</td><td>C</td><td>수강 후기 더보기</td><td>-</td>
      </tr>
      <tr style="background:#FEF2F2;">
        <td><code>notice</code> <span class="badge badge-danger">변경</span></td><td>B</td><td><strong>Default</strong></td><td>자세히 보기</td><td>히어로 블록 불필요 &rarr; Default로 이동</td>
      </tr>
      <tr style="background:#FEF2F2;">
        <td><code>promo</code> <span class="badge badge-danger">변경</span></td><td>Default</td><td>Default</td><td><strong>혜택 확인하기</strong></td><td>CTA 텍스트만 변경</td>
      </tr>
    </tbody>
  </table>

  <h3>v3 매핑 코드 (제안)</h3>
  <pre><code>const TYPE_TO_TEMPLATE: Record&lt;string, object&gt; = {
  education:  BS_CAMP_TEMPLATE_A,
  webinar:    BS_CAMP_TEMPLATE_B,
  case_study: BS_CAMP_TEMPLATE_C,
  notice:     BS_CAMP_DEFAULT_TEMPLATE,
  promo:      BS_CAMP_DEFAULT_TEMPLATE,
};

const TYPE_TO_CTA: Record&lt;string, string&gt; = {
  education:  "전체 가이드 보기",
  webinar:    "지금 등록하기",
  case_study: "수강 후기 더보기",
  notice:     "자세히 보기",
  promo:      "혜택 확인하기",
};</code></pre>

  <!-- 14. email_summary 규격 -->
  <h2 id="email-summary-spec">14. email_summary 규격</h2>

  <h3>BANNER_MAP (13개 키)</h3>
  <p><code>email-template-utils.ts:6-20</code>에 정의된 전체 배너 매핑입니다. <code>###</code> 헤딩에 키가 <strong>포함</strong>(includes)되면 매칭됩니다.</p>

  <table>
    <thead><tr><th>#</th><th>키</th><th>배너 파일</th><th>주 용도</th></tr></thead>
    <tbody>
      <tr><td>1</td><td><code>INSIGHT</code></td><td>banner-insight.png</td><td>교육 핵심 인사이트</td></tr>
      <tr><td>2</td><td><code>INSIGHT 01</code></td><td>banner-insight-01.png</td><td>교육 인사이트 1번</td></tr>
      <tr><td>3</td><td><code>INSIGHT 02</code></td><td>banner-insight-02.png</td><td>교육 인사이트 2번</td></tr>
      <tr><td>4</td><td><code>INSIGHT 03</code></td><td>banner-insight-03.png</td><td>교육 인사이트 3번</td></tr>
      <tr><td>5</td><td><code>KEY POINT</code></td><td>banner-key-point.png</td><td>핵심 포인트</td></tr>
      <tr><td>6</td><td><code>CHECKLIST</code></td><td>banner-checklist.png</td><td>체크리스트</td></tr>
      <tr><td>7</td><td><code>강의 미리보기</code></td><td>banner-preview.png</td><td>강의 프리뷰</td></tr>
      <tr><td>8</td><td><code>핵심 주제</code></td><td>banner-topics.png</td><td>주제 개요</td></tr>
      <tr><td>9</td><td><code>이런 분들을 위해</code></td><td>banner-target.png</td><td>타겟 대상</td></tr>
      <tr><td>10</td><td><code>웨비나 일정</code></td><td>banner-schedule.png</td><td>웨비나 일정</td></tr>
      <tr><td>11</td><td><code>INTERVIEW</code></td><td>banner-interview.png</td><td>인터뷰/후기</td></tr>
      <tr><td>12</td><td><code>핵심 변화</code></td><td>banner-change.png</td><td>변화/업데이트</td></tr>
      <tr><td>13</td><td><code>성과</code></td><td>banner-results.png</td><td>성과/결과</td></tr>
    </tbody>
  </table>

  <h3>타입별 필수 ### 헤딩 (v3 emailSummaryGuide)</h3>

  <div class="spec-box">
    <h4><span class="layer-tag layer-1a">education</span> 교육 콘텐츠</h4>
    <p>필수: <code>### INSIGHT</code>, <code>### KEY POINT</code>, <code>### CHECKLIST</code></p>
    <p>선택: <code>### INSIGHT 01</code> ~ <code>### INSIGHT 03</code> (3개 이상 인사이트 시)</p>
    <pre><code>### INSIGHT
(핵심 인사이트 요약 2~3문장)

### KEY POINT
&#10003; **포인트1** &mdash; 설명
&#10003; **포인트2** &mdash; 설명
&#10003; **포인트3** &mdash; 설명

### CHECKLIST
&#10003; 실천 항목 1
&#10003; 실천 항목 2
&#10003; 실천 항목 3</code></pre>
  </div>

  <div class="spec-box">
    <h4><span class="layer-tag layer-0b">webinar</span> 웨비나</h4>
    <p>필수: <code>### 핵심 주제</code>, <code>### 이런 분들을 위해</code>, <code>### 웨비나 일정</code></p>
    <pre><code>### 핵심 주제
- 주제 1
- 주제 2

### 이런 분들을 위해
&#10003; 대상 1
&#10003; 대상 2

### 웨비나 일정
- 일시: 2026년 X월 X일 (X) 20:00
- 장소: Zoom (링크 별도 안내)</code></pre>
  </div>

  <div class="spec-box">
    <h4><span class="layer-tag layer-2">case_study</span> 고객사례</h4>
    <p>필수: <code>### 성과</code>, <code>### KEY POINT</code></p>
    <p>선택: <code>### INTERVIEW</code>, <code>### 핵심 변화</code></p>
    <pre><code>### 성과
**ROAS 380%**, 월 매출 **3배** 성장

### KEY POINT
&#10003; **핵심 전략** &mdash; 설명
&#10003; **적용 방법** &mdash; 설명

### INTERVIEW
> &quot;실제 후기 인용문&quot;</code></pre>
  </div>

  <div class="spec-box">
    <h4><span class="layer-tag layer-0a">notice</span> 공지</h4>
    <p>필수: <code>### 핵심 변화</code></p>
    <p>선택: <code>### CHECKLIST</code></p>
    <pre><code>### 핵심 변화
(변경사항 요약)

### CHECKLIST
&#10003; 확인 사항 1
&#10003; 확인 사항 2</code></pre>
  </div>

  <div class="spec-box">
    <h4><span class="layer-tag layer-1b">promo</span> 홍보</h4>
    <p>필수: <code>### KEY POINT</code></p>
    <p>선택: <code>### CHECKLIST</code>, <code>### 성과</code></p>
    <pre><code>### KEY POINT
&#10003; **혜택 1** &mdash; 할인/특전 설명
&#10003; **혜택 2** &mdash; 설명
&#10003; **혜택 3** &mdash; 설명</code></pre>
  </div>

  <!-- 15. 엣지 케이스 -->
  <h2 id="edge-cases">15. 엣지 케이스 (7건)</h2>

  <p>v3 아키텍처 적용 시 고려해야 할 엣지 케이스와 대응 전략입니다.</p>

  <div class="edge-grid">
    <div class="edge-card">
      <div class="edge-id">EC-1</div>
      <div class="edge-title">RAG 검색 결과 0건</div>
      <div class="edge-desc"><strong>시나리오:</strong> 토픽이 강의 범위 밖 (예: &quot;틱톡 광고&quot;)<br>
        <strong>대응:</strong> RAG 컨텍스트 없이 기존 동작 유지. system prompt에 &quot;관련 강의 자료 없음&quot; 명시하여 hallucination 방지.</div>
    </div>
    <div class="edge-card">
      <div class="edge-id">EC-2</div>
      <div class="edge-title">email_summary에 ### 헤딩 0개</div>
      <div class="edge-desc"><strong>시나리오:</strong> AI가 가이드 무시하고 순수 텍스트만 생성<br>
        <strong>대응:</strong> Hard validation &mdash; &quot;배너 구조가 없습니다. 재생성하시겠습니까?&quot; 경고 + 재생성 버튼. 무시 후 저장도 허용.</div>
    </div>
    <div class="edge-card">
      <div class="edge-id">EC-3</div>
      <div class="edge-title">BANNER_MAP에 없는 ### 키 사용</div>
      <div class="edge-desc"><strong>시나리오:</strong> AI가 <code>### 핵심 전략</code> 같은 미등록 키 사용<br>
        <strong>대응:</strong> Soft validation &mdash; gradient fallback 적용 안내. Preview 스텝에서 &quot;미등록 배너&quot; 경고 표시.</div>
    </div>
    <div class="edge-card">
      <div class="edge-id">EC-4</div>
      <div class="edge-title">EMAIL_SUMMARY 구분자 미생성</div>
      <div class="edge-desc"><strong>시나리오:</strong> Claude가 <code>---EMAIL_SUMMARY---</code> 구분자를 생략<br>
        <strong>대응:</strong> 현재 로직 유지 (parts[1]이 없으면 빈 문자열). Preview에서 &quot;이메일 요약 없음&quot; 경고 표시.</div>
    </div>
    <div class="edge-card">
      <div class="edge-id">EC-5</div>
      <div class="edge-title">기존 notice 콘텐츠의 뉴스레터</div>
      <div class="edge-desc"><strong>시나리오:</strong> 이미 Template B로 저장된 notice 콘텐츠가 있음<br>
        <strong>대응:</strong> <code>email_design_json</code>이 이미 존재하면 매핑 변경 영향 없음 (저장된 JSON 우선 로드). 미저장 건만 Default로 변경됨.</div>
    </div>
    <div class="edge-card">
      <div class="edge-id">EC-6</div>
      <div class="edge-title">RAG 검색 지연 (5초+)</div>
      <div class="edge-desc"><strong>시나리오:</strong> pgvector RPC 응답 지연으로 생성 시간 증가<br>
        <strong>대응:</strong> 3초 타임아웃 설정. 타임아웃 시 RAG 없이 진행 (EC-1과 동일 fallback).</div>
    </div>
    <div class="edge-card">
      <div class="edge-id">EC-7</div>
      <div class="edge-title">email_summary 길이 초과</div>
      <div class="edge-desc"><strong>시나리오:</strong> AI가 3,000자 이상의 email_summary 생성<br>
        <strong>대응:</strong> emailSummaryGuide에 &quot;800~1,200자&quot; 명시. 초과 시 Preview에서 글자 수 경고 (Unlayer 렌더링은 정상 동작).</div>
    </div>
  </div>

  <!-- 16. 구현 로드맵 -->
  <h2 id="roadmap">16. 구현 로드맵</h2>

  <div class="roadmap-grid">
    <div class="roadmap-card">
      <div class="roadmap-card-header p0">
        <span class="badge badge-p0">P0</span> 즉시
      </div>
      <div class="roadmap-card-body">
        <h4 style="margin-top:0;">타입 매핑 + emailSummaryGuide 강화</h4>
        <p>예상 변경: <strong>~35줄</strong></p>
        <p>의존성: 없음</p>
        <p style="margin-bottom:8px;">수정 파일:</p>
        <span class="file-tag">email-template-utils.ts</span>
        <span class="file-tag">contents.ts</span>
        <p style="margin-top:12px;">변경 내용:</p>
        <ul style="font-size:12px;">
          <li>TYPE_TO_TEMPLATE 상수 추가 (webinar&rarr;B, notice&rarr;Default)</li>
          <li>TYPE_TO_CTA 상수 추가</li>
          <li>buildDesignFromSummary() if-else &rarr; 상수 참조로 변경</li>
          <li>TYPE_PROMPTS.emailSummaryGuide에 BANNER_MAP 키 + 필수 ### 목록 추가</li>
        </ul>
      </div>
    </div>

    <div class="roadmap-card">
      <div class="roadmap-card-header p1">
        <span class="badge badge-p1">P1</span> 1~2일
      </div>
      <div class="roadmap-card-body">
        <h4 style="margin-top:0;">RAG 연결</h4>
        <p>예상 변경: <strong>~50줄</strong></p>
        <p>의존성: P0 완료 후</p>
        <p style="margin-bottom:8px;">수정 파일:</p>
        <span class="file-tag">contents.ts</span>
        <span class="file-tag">rag.ts</span>
        <p style="margin-top:12px;">변경 내용:</p>
        <ul style="font-size:12px;">
          <li>generateContentWithAI()에 searchRelevantChunks() 호출 추가</li>
          <li>RAG 컨텍스트를 system prompt에 주입 (3,000자 예산)</li>
          <li>fallback: 청크 0건 &rarr; 기존 동작 유지</li>
          <li>타임아웃: 3초 (AbortSignal.timeout)</li>
        </ul>
      </div>
    </div>

    <div class="roadmap-card">
      <div class="roadmap-card-header p2">
        <span class="badge badge-p2">P2</span> 3~5일
      </div>
      <div class="roadmap-card-body">
        <h4 style="margin-top:0;">미리보기 UX + 검증</h4>
        <p>예상 변경: <strong>~175줄</strong></p>
        <p>의존성: P0 + P1 완료 후</p>
        <p style="margin-bottom:8px;">수정 파일:</p>
        <span class="file-tag">new-content-modal.tsx</span>
        <span class="file-tag">email-template-utils.ts</span>
        <span class="file-tag">contents.ts</span>
        <p style="margin-top:12px;">변경 내용:</p>
        <ul style="font-size:12px;">
          <li>FlowStep에 &quot;preview&quot; 추가</li>
          <li>Preview 스텝 UI: 제목, ### 헤딩 분석, 배너 매칭 상태</li>
          <li>validateEmailSummary() 유틸 함수 (soft + hard 검증)</li>
          <li>&quot;재생성&quot; / &quot;저장&quot; 버튼</li>
          <li>모달 폭 640px 확장</li>
        </ul>
      </div>
    </div>
  </div>

  <h3>전체 타임라인</h3>
  <table>
    <thead>
      <tr><th>우선순위</th><th>PR 제목</th><th>파일</th><th>예상 변경</th><th>의존성</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><span class="badge badge-p0">P0</span></td>
        <td>fix: 타입 매핑 교정 + emailSummaryGuide 강화</td>
        <td><code>email-template-utils.ts</code>, <code>contents.ts</code></td>
        <td>~35줄</td>
        <td>없음</td>
      </tr>
      <tr>
        <td><span class="badge badge-p1">P1</span></td>
        <td>feat: RAG 컨텍스트를 콘텐츠 생성에 연결</td>
        <td><code>contents.ts</code>, <code>rag.ts</code></td>
        <td>~50줄</td>
        <td>P0</td>
      </tr>
      <tr>
        <td><span class="badge badge-p2">P2</span></td>
        <td>feat: 미리보기 + email_summary 구조 검증</td>
        <td><code>new-content-modal.tsx</code>, <code>email-template-utils.ts</code>, <code>contents.ts</code></td>
        <td>~175줄</td>
        <td>P0+P1</td>
      </tr>
    </tbody>
  </table>


  <!-- 17. 통합 지식 서비스 -->
  <h2 id="unified-knowledge">17. 통합 지식 서비스 (Unified Knowledge Service)</h2>

  <h3>현재 문제: 생성 엔진 파편화</h3>
  <div class="summary-box">
    <strong>핵심 갭:</strong> QA 답변은 <code>Gemini 2.5 Flash</code>(rag.ts &rarr; gemini.ts:44), 콘텐츠 생성은 <code>Claude Sonnet 4</code>(contents.ts:637)를 사용합니다.
    동일한 강의 지식을 기반으로 하지만 <strong>서로 다른 LLM이 서로 다른 품질</strong>의 결과를 생성하는 파편화 상태입니다.
  </div>

  <table>
    <thead><tr><th>항목</th><th>QA 답변 (현재)</th><th>콘텐츠 생성 (현재)</th><th>v3 통합 (제안)</th></tr></thead>
    <tbody>
      <tr><td>LLM</td><td>Gemini 2.5 Flash</td><td>Claude Sonnet 4</td><td><strong>Opus 4.6</strong> (단일)</td></tr>
      <tr><td>RAG 소스</td><td>lecture_chunks (pgvector)</td><td>미연결</td><td>lecture_chunks (공유)</td></tr>
      <tr><td>프롬프트</td><td>gemini.ts 하드코딩</td><td>TYPE_PROMPTS 상수</td><td>KnowledgeService 통합</td></tr>
      <tr><td>출력 형식</td><td>마크다운 답변</td><td>title + bodyMd + emailSummary</td><td>Consumer별 어댑터</td></tr>
      <tr><td>품질</td><td>중 (Flash 급)</td><td>상 (Sonnet 급)</td><td><strong>최상 (Opus 급)</strong></td></tr>
    </tbody>
  </table>

  <h3>v3 제안: Knowledge Layer + Consumer 패턴</h3>
  <p>하나의 <strong>Knowledge Layer</strong>가 RAG 검색 + LLM 생성을 담당하고, 다수의 <strong>Consumer</strong>가 용도별 어댑터를 통해 결과를 소비합니다.</p>

  <table>
    <thead><tr><th>#</th><th>Consumer</th><th>현재 파일</th><th>출력 형식</th><th>비고</th></tr></thead>
    <tbody>
      <tr><td>1</td><td>QA AI 답변</td><td><code>rag.ts</code> &rarr; <code>gemini.ts</code></td><td>마크다운 답변 + sourceRefs</td><td>Gemini &rarr; Opus 전환</td></tr>
      <tr><td>2</td><td>뉴스레터 콘텐츠</td><td><code>contents.ts</code> L623</td><td>title + bodyMd + emailSummary</td><td>RAG 주입 추가 (ADR-1)</td></tr>
      <tr><td>3</td><td>정보공유 콘텐츠</td><td><code>contents.ts</code> (education)</td><td>title + bodyMd</td><td>교육 콘텐츠 재활용</td></tr>
      <tr><td>4</td><td>웨비나 모집글</td><td><code>contents.ts</code> (webinar)</td><td>title + bodyMd + 일정 정보</td><td>TYPE_PROMPTS.webinar 활용</td></tr>
      <tr><td>5</td><td>향후 확장 (챗봇 등)</td><td>미구현</td><td>스트리밍 답변</td><td>Knowledge Layer API 재활용</td></tr>
    </tbody>
  </table>

  <pre class="mermaid">
graph TB
  subgraph Knowledge["Knowledge Layer"]
    RAG["RAG Engine\n(pgvector + embedding)"]
    LLM["Opus 4.6\n(Anthropic API)"]
    KS["KnowledgeService\n(통합 인터페이스)"]
    RAG -->|"context"| KS
    KS -->|"prompt + context"| LLM
    LLM -->|"response"| KS
  end

  subgraph Consumers["Consumers"]
    C1["QA AI 답변\n(answers 테이블)"]
    C2["뉴스레터\n(contents + email_summary)"]
    C3["정보공유\n(contents 게시)"]
    C4["웨비나 모집글\n(contents + 일정)"]
    C5["향후 확장\n(챗봇, API 등)"]
  end

  subgraph Storage["Data Sources"]
    LC2["lecture_chunks\n(강의 자료)"]
    QA["questions\n(수강생 질문)"]
    CR["crawled_data\n(외부 크롤링)"]
  end

  LC2 --> RAG
  QA --> RAG
  CR -.->|"Phase 2"| RAG

  KS --> C1
  KS --> C2
  KS --> C3
  KS --> C4
  KS -.->|"향후"| C5

  style Knowledge fill:#FEF2F2,stroke:#F75D5D,stroke-width:2px
  style KS fill:#FEE2E2,stroke:#F75D5D
  style LLM fill:#DBEAFE,stroke:#1E40AF
  </pre>

  <h3>통합 시 변경 범위</h3>
  <table>
    <thead><tr><th>변경</th><th>파일</th><th>내용</th><th>우선순위</th></tr></thead>
    <tbody>
      <tr><td>KnowledgeService 생성</td><td><code>src/lib/knowledge.ts</code> (신규)</td><td>RAG 검색 + Opus API 호출 통합</td><td>P2</td></tr>
      <tr><td>QA 답변 전환</td><td><code>src/lib/rag.ts</code></td><td>generateRAGAnswer() &rarr; KnowledgeService 위임</td><td>P2</td></tr>
      <tr><td>콘텐츠 생성 전환</td><td><code>src/actions/contents.ts</code></td><td>generateContentWithAI() &rarr; KnowledgeService 위임</td><td>P2</td></tr>
      <tr><td>Gemini 역할 축소</td><td><code>src/lib/gemini.ts</code></td><td>generateAnswer() 제거, generateEmbedding()만 유지</td><td>P2</td></tr>
    </tbody>
  </table>

  <!-- ADR-6 -->
  <h3 id="adr-6">ADR-6: LLM 통합 &mdash; Gemini &rarr; Opus 4.6</h3>

  <div class="adr">
    <div class="adr-header">
      <span class="adr-num">ADR-6</span>
      <span class="adr-title">모든 생성 작업을 Opus 4.6으로 통합</span>
    </div>
    <div class="adr-body">
      <div class="adr-section">
        <div class="adr-section-title">맥락 (Context)</div>
        <p>현재 QA 답변은 <code>Gemini 2.5 Flash</code>(gemini.ts:44)를 사용하고, 콘텐츠 생성은 <code>Claude Sonnet 4</code>(contents.ts:645)를 사용합니다.
          두 모델은 품질 차이가 있으며, 프롬프트 엔지니어링이 각각 별도로 관리됩니다.
          Opus 4.6은 현재 사용 가능한 가장 강력한 모델이며, 일관된 품질과 단일 프롬프트 관리를 가능하게 합니다.</p>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">선택지 (Options)</div>
        <table>
          <thead><tr><th>옵션</th><th>설명</th><th>장점</th><th>단점</th></tr></thead>
          <tbody>
            <tr><td><strong>A. Opus 4.6 단일화</strong></td><td>모든 생성을 Opus로 통합</td><td>최고 품질, 단일 프롬프트, 유지보수 간소화</td><td>비용 증가 (Opus > Sonnet > Flash)</td></tr>
            <tr><td>B. Sonnet 4.5 단일화</td><td>모든 생성을 Sonnet으로 통합</td><td>품질-비용 균형, Gemini 종속 제거</td><td>Opus보다 낮은 품질</td></tr>
            <tr><td>C. 현행 유지</td><td>QA=Gemini, 콘텐츠=Sonnet</td><td>비용 최소</td><td>파편화 지속, 품질 불일치</td></tr>
            <tr><td>D. 용도별 최적화</td><td>QA=Sonnet(빠름), 콘텐츠=Opus(품질)</td><td>용도별 최적</td><td>2개 API 관리, 복잡성 유지</td></tr>
          </tbody>
        </table>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결정 (Decision)</div>
        <p><strong>옵션 A: Opus 4.6 단일화</strong>를 선택합니다.</p>
        <p>이유:</p>
        <ul>
          <li>자사몰사관학교의 <strong>QA 답변 품질이 브랜드 신뢰도에 직결</strong> &mdash; &quot;가장 똑똑한 모델이 모든 답변&quot; 원칙</li>
          <li>QA 호출 빈도가 높지 않아 (일 10-50건 추정) 비용 영향 제한적</li>
          <li>Gemini API 키 + Anthropic API 키 이중 관리 &rarr; Anthropic 단일로 간소화</li>
          <li><code>generateEmbedding()</code>은 Gemini text-embedding-004 유지 (임베딩 전용, 비용 매우 낮음)</li>
        </ul>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결과 (Consequences)</div>
        <div class="consequence"><span class="plus">[+]</span> QA 답변 품질 대폭 향상 (Flash &rarr; Opus)</div>
        <div class="consequence"><span class="plus">[+]</span> 프롬프트 엔지니어링 단일 관리 (Anthropic 형식 통일)</div>
        <div class="consequence"><span class="plus">[+]</span> KnowledgeService로 코드 응집도 향상</div>
        <div class="consequence"><span class="minus">[-]</span> QA 응답 비용 증가 (~10x per call), 월 총비용은 호출량 감안 시 수용 가능</div>
        <div class="consequence"><span class="minus">[-]</span> Opus 지연시간이 Flash보다 길 수 있음 (2-5초 vs 0.5-1초)</div>
        <div class="consequence"><span class="neutral">[~]</span> 임베딩은 Gemini text-embedding-004 유지 (교체 불필요, 768차원 호환)</div>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">관련 코드</div>
        <p>
          <code>src/lib/gemini.ts:44-90</code> &mdash; generateAnswer() 제거 대상<br>
          <code>src/lib/gemini.ts:15-38</code> &mdash; generateEmbedding() 유지<br>
          <code>src/lib/rag.ts:55-98</code> &mdash; generateRAGAnswer() &rarr; KnowledgeService 위임<br>
          <code>src/actions/contents.ts:623-698</code> &mdash; generateContentWithAI() &rarr; KnowledgeService 위임<br>
          <code>src/lib/knowledge.ts</code> &mdash; 신규 파일 (KnowledgeService)
        </p>
      </div>
    </div>
  </div>

  <!-- 18. Layer 0 진화 로드맵 -->
  <h2 id="rag-evolution">18. Layer 0 진화 로드맵 (Flat RAG &rarr; Filtered RAG)</h2>

  <h3>현재 lecture_chunks 스키마 분석</h3>

  <div class="summary-box">
    <strong>스키마 현황:</strong> <code>lecture_chunks</code> 테이블은 <code>id</code>, <code>lecture_name</code>, <code>week</code>,
    <code>chunk_index</code>, <code>content</code>, <code>embedding</code>, <code>created_at</code> 7개 컬럼만 보유합니다.
    <strong>source_type, file_path, metadata 컬럼이 없어</strong> 현재는 메타데이터 기반 필터링이 불가합니다.
    다만 <code>lecture_name</code>과 <code>week</code>로 제한적인 필터링은 가능합니다.
  </div>

  <table>
    <thead><tr><th>컬럼</th><th>타입</th><th>필터링 활용</th><th>한계</th></tr></thead>
    <tbody>
      <tr><td><code>lecture_name</code></td><td>string</td><td>강의명으로 범위 제한 가능</td><td>명칭 규칙 비표준화, 크롤링 데이터 구분 불가</td></tr>
      <tr><td><code>week</code></td><td>string</td><td>주차별 필터링 가능</td><td>크롤링/QA 데이터에는 week 개념 없음</td></tr>
      <tr><td><code>chunk_index</code></td><td>number</td><td>순서 기반 정렬만</td><td>필터링에 부적합</td></tr>
      <tr><td><code>embedding</code></td><td>vector(768)</td><td>유사도 검색 전용</td><td>메타데이터 필터링 불가</td></tr>
      <tr><td colspan="4" style="text-align:center;color:var(--primary);font-weight:600;">source_type, metadata, cohort, topic &mdash; 모두 없음</td></tr>
    </tbody>
  </table>

  <h3>3단계 진화 로드맵</h3>

  <div class="roadmap-grid">
    <div class="roadmap-card">
      <div class="roadmap-card-header p0">
        <span class="badge badge-p0">Phase 1</span> 현재 (~200 청크)
      </div>
      <div class="roadmap-card-body">
        <h4 style="margin-top:0;">플랫 RAG + 유사도 우선</h4>
        <p><strong>전략:</strong> 모든 청크를 한번에 검색, 유사도 순 반환</p>
        <p><strong>이유:</strong> 200개 이하에서는 노이즈가 제한적이며, pgvector의 HNSW 인덱스가 충분히 빠름</p>
        <p style="margin-bottom:8px;"><strong>가능한 최적화:</strong></p>
        <ul style="font-size:12px;">
          <li><code>lecture_name</code> 기반 우선순위 재정렬 (강의 자료 > 기타)</li>
          <li>유사도 threshold 0.4 이하 결과 필터링 (현재 구현됨)</li>
          <li>토큰 예산 3,000자 제한 (ADR-5)</li>
        </ul>
        <p style="margin-top:8px;"><strong>DB 변경:</strong> 없음</p>
      </div>
    </div>

    <div class="roadmap-card">
      <div class="roadmap-card-header p1">
        <span class="badge badge-p1">Phase 2</span> 500개+ 청크
      </div>
      <div class="roadmap-card-body">
        <h4 style="margin-top:0;">메타데이터 필터링 도입</h4>
        <p><strong>전략:</strong> <code>metadata</code> jsonb 컬럼 추가, 검색 시 pre-filter</p>
        <p style="margin-bottom:8px;"><strong>필요한 메타데이터:</strong></p>
        <ul style="font-size:12px;">
          <li><code>source_type</code>: lecture | qa | meeting | crawl</li>
          <li><code>cohort</code>: 기수 정보 (1기, 2기, ...)</li>
          <li><code>topic</code>: 주제 태그 배열</li>
          <li><code>quality_score</code>: 콘텐츠 품질 점수 (0-1)</li>
        </ul>
        <p style="margin-top:8px;"><strong>DB 변경:</strong></p>
        <pre><code>ALTER TABLE lecture_chunks
ADD COLUMN metadata jsonb DEFAULT '{}'::jsonb;

-- 인덱스
CREATE INDEX idx_chunks_metadata_source
ON lecture_chunks ((metadata->>'source_type'));

-- RPC 수정: WHERE 절에 메타데이터 필터 추가
-- match_lecture_chunks(query_embedding, threshold, count, filters jsonb)</code></pre>
      </div>
    </div>

    <div class="roadmap-card">
      <div class="roadmap-card-header p2">
        <span class="badge badge-p2">Phase 3</span> 1,000개+ 청크
      </div>
      <div class="roadmap-card-body">
        <h4 style="margin-top:0;">도메인별 분리 또는 하이브리드</h4>
        <p><strong>전략:</strong> 도메인별 벡터 저장소 분리, 또는 키워드+벡터 하이브리드 검색</p>
        <p style="margin-bottom:8px;"><strong>옵션:</strong></p>
        <ul style="font-size:12px;">
          <li><strong>A. 도메인 분리:</strong> lecture_chunks, qa_chunks, crawl_chunks 별도 테이블</li>
          <li><strong>B. 하이브리드:</strong> pgvector + pg_trgm 결합 (벡터 유사도 + 키워드 매칭)</li>
          <li><strong>C. 외부 서비스:</strong> Pinecone, Weaviate 등 전용 벡터 DB (비용 증가)</li>
        </ul>
        <p style="margin-top:8px;"><strong>DB 변경:</strong> 테이블 분리 또는 인덱스 전략 변경</p>
      </div>
    </div>
  </div>

  <h3>Phase별 의사결정 트리거</h3>
  <table>
    <thead><tr><th>트리거</th><th>현재 값</th><th>Phase 2 전환 기준</th><th>Phase 3 전환 기준</th></tr></thead>
    <tbody>
      <tr><td>총 청크 수</td><td>~100-200</td><td>&gt; 500</td><td>&gt; 1,000</td></tr>
      <tr><td>검색 노이즈율</td><td>낮음</td><td>유사도 0.4+ 결과 중 비관련 &gt; 20%</td><td>필터링 후에도 &gt; 10%</td></tr>
      <tr><td>데이터 소스 종류</td><td>강의 자료만</td><td>+ QA 답변, 크롤링</td><td>+ 미팅록, 외부 API</td></tr>
      <tr><td>검색 지연</td><td>&lt; 1초</td><td>&gt; 2초</td><td>&gt; 3초</td></tr>
    </tbody>
  </table>

  <h3>lecture_chunks 필터링 가능성 (현재 스키마)</h3>

  <div class="edge-grid">
    <div class="edge-card">
      <div class="edge-id">현재 가능</div>
      <div class="edge-title">lecture_name 기반 필터링</div>
      <div class="edge-desc"><code>lecture_name</code>에 강의 구분 정보가 포함되어 있으면 WHERE 절로 범위 제한 가능.
        예: <code>WHERE lecture_name LIKE '%메타광고%'</code>. 단, 네이밍 규칙이 표준화되어 있어야 효과적.</div>
    </div>
    <div class="edge-card">
      <div class="edge-id">현재 가능</div>
      <div class="edge-title">week 기반 필터링</div>
      <div class="edge-desc"><code>week</code> 컬럼으로 특정 주차 범위 제한 가능. 예: 초급(1-4주), 중급(5-8주).
        QA 컨텍스트에서 질문자의 진도에 맞는 답변 제공에 활용 가능.</div>
    </div>
    <div class="edge-card">
      <div class="edge-id">불가</div>
      <div class="edge-title">source_type 구분</div>
      <div class="edge-desc">강의 자료 vs 크롤링 데이터 vs QA 답변 구분이 불가. 향후 크롤링 데이터 유입 시
        <code>metadata jsonb</code> 컬럼 추가가 필수.</div>
    </div>
    <div class="edge-card">
      <div class="edge-id">불가</div>
      <div class="edge-title">cohort/topic 태그</div>
      <div class="edge-desc">기수별 콘텐츠 필터링, 주제별 태그 기반 검색 모두 불가. Phase 2에서 metadata jsonb로 해결.</div>
    </div>
  </div>

  <!-- ADR-7 -->
  <h3 id="adr-7">ADR-7: RAG 진화 전략</h3>

  <div class="adr">
    <div class="adr-header">
      <span class="adr-num">ADR-7</span>
      <span class="adr-title">RAG 진화: 플랫 &rarr; 메타데이터 필터링 전환 기준</span>
    </div>
    <div class="adr-body">
      <div class="adr-section">
        <div class="adr-section-title">맥락 (Context)</div>
        <p>현재 <code>lecture_chunks</code> 테이블은 7개 컬럼(id, lecture_name, week, chunk_index, content, embedding, created_at)만 보유합니다.
          <code>match_lecture_chunks</code> RPC는 순수 벡터 유사도 검색만 수행합니다(rag.ts:38).
          청크 수가 ~200개로 플랫 검색이 충분하지만, 향후 크롤링 데이터나 QA 답변이 유입되면 노이즈가 증가합니다.</p>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">선택지 (Options)</div>
        <table>
          <thead><tr><th>옵션</th><th>설명</th><th>장점</th><th>단점</th></tr></thead>
          <tbody>
            <tr><td><strong>A. 지금은 플랫, 500개 초과 시 전환</strong></td><td>Phase 1 유지, 트리거 기준 모니터링</td><td>불필요한 선행 작업 없음, YAGNI 원칙</td><td>전환 시 마이그레이션 필요</td></tr>
            <tr><td>B. 즉시 metadata 추가</td><td>지금 jsonb 컬럼 + 인덱스 추가</td><td>향후 전환 비용 제거</td><td>현재 활용도 0, 과도한 엔지니어링</td></tr>
            <tr><td>C. 외부 벡터 DB 도입</td><td>Pinecone/Weaviate로 이전</td><td>풍부한 메타데이터 기능</td><td>비용, 복잡성, pgvector 이전 작업</td></tr>
          </tbody>
        </table>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결정 (Decision)</div>
        <p><strong>옵션 A: 지금은 플랫, 500개 초과 시 메타데이터 필터링 전환</strong>을 선택합니다.</p>
        <p>이유:</p>
        <ul>
          <li>현재 ~200개 청크에서 플랫 검색이 충분히 정확 (threshold 0.4로 노이즈 제어)</li>
          <li>크롤링 데이터 유입이 아직 구체적 계획 없음 &mdash; YAGNI(You Aren&rsquo;t Gonna Need It)</li>
          <li>Phase 1에서 <code>lecture_name</code> 기반 우선순위 재정렬로 즉시 개선 가능</li>
          <li>500개 초과 시 <code>ALTER TABLE ADD COLUMN metadata jsonb</code>는 PostgreSQL에서 즉시 반영 (테이블 리라이트 없음)</li>
        </ul>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">결과 (Consequences)</div>
        <div class="consequence"><span class="plus">[+]</span> 현재 불필요한 스키마 변경 없음, DB 안정성 유지</div>
        <div class="consequence"><span class="plus">[+]</span> 플랫 RAG의 단순함으로 디버깅/유지보수 용이</div>
        <div class="consequence"><span class="minus">[-]</span> 500개 초과 시 마이그레이션 비용 발생 (jsonb 추가 + RPC 수정 + 기존 데이터 태깅)</div>
        <div class="consequence"><span class="neutral">[~]</span> 모니터링 지표(청크 수, 노이즈율) 추적 필요</div>
      </div>
      <div class="adr-section">
        <div class="adr-section-title">관련 코드</div>
        <p>
          <code>src/types/database.ts:335-364</code> &mdash; lecture_chunks 스키마 (현재 7컬럼)<br>
          <code>src/lib/rag.ts:26-50</code> &mdash; searchRelevantChunks() (Phase 2에서 filters 파라미터 추가)<br>
          Supabase RPC: <code>match_lecture_chunks</code> (Phase 2에서 WHERE 절 확장)
        </p>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer id="footer">
    <p>생성일: 2026-02-15 &nbsp;|&nbsp; 작성: leader (에이전트)</p>
    <p>참조 파일:</p>
    <ul style="margin:4px 0;">
      <li><code>src/actions/contents.ts</code> &mdash; generateContentWithAI (L623-698), TYPE_PROMPTS (L519-621)</li>
      <li><code>src/lib/knowledge.ts</code> &mdash; KnowledgeService (v3 제안, 신규 파일)</li>
      <li><code>src/lib/email-template-utils.ts</code> &mdash; BANNER_MAP (L6-20), buildDesignFromSummary (L250-351)</li>
      <li><code>src/lib/rag.ts</code> &mdash; searchRelevantChunks (L26-50), generateRAGAnswer (L55-98)</li>
      <li><code>src/lib/gemini.ts</code> &mdash; generateEmbedding (L15-38), generateAnswer (L44-90)</li>
      <li><code>src/components/content/new-content-modal.tsx</code> &mdash; FlowStep UI (L1-375)</li>
      <li><code>src/components/content/newsletter-edit-panel.tsx</code> &mdash; Unlayer + send (L56-298)</li>
      <li><code>src/types/database.ts</code> &mdash; contents, lecture_chunks, email_logs 스키마</li>
    </ul>
  </footer>

</div><!-- .main -->

<!-- Scroll Spy -->
<script>
(function() {
  var links = document.querySelectorAll('#toc a');
  var sections = [];
  links.forEach(function(link) {
    var id = link.getAttribute('href');
    if (id) {
      var el = document.getElementById(id.replace('#', ''));
      if (el) sections.push({ el: el, link: link });
    }
  });
  if (!sections.length) return;
  var observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        links.forEach(function(l) { l.classList.remove('active'); });
        for (var i = 0; i < sections.length; i++) {
          if (sections[i].el === entry.target) {
            sections[i].link.classList.add('active');
            break;
          }
        }
      }
    });
  }, { rootMargin: '-20% 0px -70% 0px' });
  sections.forEach(function(s) { observer.observe(s.el); });
})();
</script>

</body>
</html>
