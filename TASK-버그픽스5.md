# TASK-버그픽스5.md — 뒤로가기 로딩 버그 + 타겟중복 500 에러

> 작성: 모찌 | 2026-02-26
> 우선순위: 높음

---

## ⚠️ 절대 규칙

1. **기존 코드를 먼저 읽어라.** 수정 대상 파일을 반드시 먼저 확인.
2. **"이미 구현됨" 판단 금지.** 현재 동작과 아래 스펙을 비교하여 다르면 수정.
3. **수정 후 반드시:** `npm run build` + `npx tsc --noEmit` PASS 확인 후 커밋.

---

## T1. 큐레이션→컨텐츠→정보공유 뒤로가기 로딩 버그

### 증상
- 큐레이션 목록 → 컨텐츠 상세 → 뒤로가기 시 탭이 초기화되면서 전체 페이지 리로딩
- 정보공유 목록 → 상세 → 뒤로가기에서도 동일
- 사용자 경험: 스크롤 위치 손실 + 탭 리셋 + 로딩 스피너 재표시

### 원인 추정
- Next.js App Router에서 클라이언트 네비게이션 시 탭 상태가 URL에 저장되지 않음
- 뒤로가기 시 컴포넌트 리마운트 → 탭 기본값으로 리셋
- 또는 fetch가 매번 재실행되어 로딩 상태 표시

### 수정 방향
1. **탭 상태를 URL searchParams에 저장** — `?tab=curation` 등
2. **뒤로가기 시 searchParams에서 탭 복원**
3. **SWR/React Query 캐시** 활용하여 이미 로드된 데이터 재사용 (fetch 중복 방지)
4. 또는 **shallow routing** (`router.push(url, { scroll: false })`) 활용

### 수정 대상 파일 (추정)
- `src/app/(main)/curation/` — 큐레이션 관련 페이지
- `src/app/(main)/info-share/` — 정보공유 관련 페이지
- `src/app/(main)/content/` — 컨텐츠 관련 페이지
- 탭 컴포넌트 — 상태를 URL param으로 동기화

### 완료 기준
- [ ] 큐레이션 → 상세 → 뒤로가기: 탭 유지 + 로딩 없음
- [ ] 정보공유 → 상세 → 뒤로가기: 탭 유지 + 로딩 없음
- [ ] 컨텐츠 → 상세 → 뒤로가기: 탭 유지 + 로딩 없음
- [ ] 스크롤 위치 유지 (가능하면)

---

## T2. 타겟중복 500 에러 수정

### 증상
- 타겟중복 탭 진입 시 500 Internal Server Error
- API: `/api/protractor/overlap`
- 이전 QA에서 FAIL 기록 있음

### 원인 추정
- Meta API 토큰 문제 (만료 또는 권한 부족)
- adset reach 조회 시 타임아웃 (이전 버그픽스3에서 타임아웃 추가했으나 부족할 수 있음)
- overlap 계산 로직에서 0개 adset일 때 division by zero
- 캐시 테이블 존재 여부 미확인

### 수정 방향
1. **에러 핸들링 강화** — Meta API 실패 시 graceful fallback
2. **adset 0개일 때** 빈 결과 반환 (에러 대신)
3. **타임아웃 증가** 또는 **병렬 요청 제한** (동시 5개 → 3개)
4. **캐시 테이블 존재 확인** — 없으면 생성 안내 또는 자동 생성
5. **에러 메시지 개선** — 사용자에게 구체적 안내 (예: "활성 캠페인이 없습니다")

### 수정 대상 파일
- `src/app/api/protractor/overlap/route.ts` — 에러 핸들링 강화
- `src/app/(main)/protractor/components/overlap-analysis.tsx` — 에러 UI 개선
- DB 마이그레이션: `adset_overlap_cache` 테이블 존재 확인

### 완료 기준
- [ ] 타겟중복 탭 진입 시 500 에러 없음
- [ ] 활성 캠페인 0개 → "활성 캠페인이 없습니다" 안내
- [ ] Meta API 실패 → 구체적 에러 메시지 (토큰 만료 등)
- [ ] 정상 계정에서 중복율 데이터 표시

---

## 타입
개발

## 리뷰 결과

### T1. 뒤로가기 로딩 버그
- 현재: 콘텐츠 상세 페이지의 뒤로가기가 `<Link href="/admin/content">`로 하드코딩 → 탭 파라미터(`?tab=`) 소실 → 기본값 "curation"으로 리셋 + 페이지 리마운트로 로딩 스피너 재표시
- 목업: 큐레이션/콘텐츠/정보공유 어느 탭에서든 상세 진입 후 뒤로가기 시 이전 탭 상태 및 스크롤 위치 유지
- 변경: `<Link href="/admin/content">`를 `router.back()`으로 교체하여 브라우저 히스토리 스택에서 이전 URL(탭 파라미터 포함) 복원. bfcache로 컴포넌트 상태도 보존되어 로딩 없음.

### T2. 타겟중복 500 에러
- 현재: overlap API에서 Meta API 토큰 만료/미설정, 타임아웃, 캐시 테이블 미존재 시 모두 일괄 "서버 오류가 발생했습니다"로 500 반환. 전체 reach 조회 실패 시 전체 응답 실패.
- 목업: 에러 원인별 구체적 안내 메시지 표시 (토큰 만료 → "광고계정을 다시 연결해주세요", 타임아웃 → "잠시 후 다시 시도해주세요", 활성 캠페인 없음 → 안내)
- 변경: (1) catch 블록에서 에러 메시지 파싱하여 토큰/Meta API/타임아웃별 구체적 HTTP 상태코드+메시지 반환 (2) fetchCombinedReach 실패 시 individualSum으로 fallback (3) 캐시 저장 실패 non-fatal 처리 (4) OverlapAnalysis UI에서 토큰 에러 전용 UI 표시

## 금지 사항
- 다크모드 스타일 추가 금지
- 기존 동작하는 기능 변경 금지
- 목업에 없는 UI 요소 추가 금지
